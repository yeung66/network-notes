# 5 网络层：控制平面

## 路由选择算法

从发送方到接收方确定一条通过路由器网络的路径，通常好路径具有最低的开销

### 分类

- 集中式/分布式
- 动态/静态
  - 静态：少变，由人工进行调整
  - 动态：随着流量变化或拓扑结构改变而改变路径
- 负载敏感/迟钝：链路开销动态变化反映拥塞水平，路径选择趋向于避开拥塞

### 集中式路由选择算法

用完整全局性网络知识计算最低开销路径，即在计算前已知所有节点的连通性以及开销

通常称为链路状态算法（Link State，LS）算法

#### 链路状态路由选择算法

每个节点需要通过广播向其它节点提供链路状态分组，通过链路状态广播算法完成

##### Dijkstra算法

- 初始化：将源点加入已确定集合，与其相邻的节点最低开销设为两节点的链路开销，并设置前驱节点，其余点开销设为无穷
- n-1轮迭代：从最低开销里找出一个节点，将其加入已确定集合，更新其所有未确定邻接点的最低开销路径以及前驱节点
- 最终最短路径通过其前驱倒推
- 时间复杂度$O(n^2)$，使用最小堆可以优化为$O(n\log n)$

#### 振荡问题

链路开销等于链路上承载的负载，且是非对称的，因而随着路径选择的变更，开销也会变更

因此可能会一直震荡，一直选择变换最短开销路径

### 分散式路由选择算法

通过迭代、分布式方法计算最低开销路径，每个节点只有与其直连的链路开销知识

#### 距离向量算法DV

- 迭代：过程一直持续到无更多信息交换
- 分布式：每个节点从一个或多个邻居接受信息
- 异步：不要求节点步伐一致地操作
- 基本思想：
  1. 每个节点构造自身距离向量，并向邻接点传播
  2. 节点收到距离向量后，更新自身距离向量
  3. 若距离向量更新/链路开销改变，也向邻接点发送更新的距离向量
  4. 最终会停留在静止状态
- 问题：
  - 选择环路：在链路开销变大时，更新的最短开销路径可能是错误的，表现为A经过B又回来A
  - 无穷计数：链路开销增加传播很慢，需要迭代很多次
    - 毒性逆转：路由的前驱告诉路由中转点前驱到目的节点的距离为无穷

##### Bellman-Ford方程

$$d_x(y)=min_v\{c(x,y)+d_v(y)\}$$

### 算法比较

- 报文复杂性：LS为$O(|N||E|)$
- 收敛速度：LS为$O(|N|^2)$，DV收敛慢，收敛时会遇到选择环路，可能有无穷计数问题
- 健壮性：LS计算是分离的，健壮性较好；DV错误会扩散

## 自治系统内部路由选择：OSPF

为什么要设置自治系统：

- 规模：规模太大，难以存储与计算。
- 管理自治：组织希望按照自己的愿望运行和管理网络

自治系统（Autonomous System）AS，通常由一个ISP中路由器和互联的链路组成，但某些ISP也可以划分为多个AS

自治系统内部运行的路由选择算法为**自治系统内部路由选择算法**(intra-autonomous system routing)

### 开放最短路优先（Open Shortest Path First

- 开放：路由选择协议规范是公开可用的
- 链路状态协议，采用洪泛链路状态信息和Dijkstra最低开销路径算法
- 每个路由器均有完整拓扑图，本地运行Dijkstra算法，确定自身为根节点到所有子网的最短路径树
- 链路开销有网络管理员设置，可为1（最少跳数）或设置权值
- 路由器向自治系统内部所有路由器广播路由选择信息
- 链路状态改变时/定时广播链路状态信息

#### 优点

- 安全：路由器需要鉴别
- 允许多条相同开销路径
- 单播多播综合支持
- 支持单个AS的层次系统

## ISP间路由选择：BGP

网关边界协议Boarder Gateway Protocol 是自治系统间路由选择协议

- 网关路由器：处于AS边缘，连接了其他AS的路由器
- 内部路由器

### 作用

BGP中的路由为路由到CIDR化的前缀，每个前缀表示一个子网或子网集合

1. 从邻居AS获取前缀的可达性信息
2. 选择到某前缀的最好的路由

### BGP通知

每对路由器通过179端口进行半永久TCP连接，交换BGP报文，称为**BGP连接**

- 外部BGP（eBGP：跨越AS的BGP连接
- 内部BGP（iBGP：相同AS中路由器的BGP连接

如何传输可达性消息

1. 网关路由器通过eBGP向直接连接的其它AS的网关路由器发送某个前缀的可达性信息：AS名字+前缀
2. 接收到的网关路由器自己AS内部所以其它路由器发送iBGP
3. 其它的网关路由器再向另一AS的网关路由器发送eBGP

### 路由选择

重要属性

- AS-PATH：已经通过的AS列表
- NEXT-HOP：AS-PATH起始的路由器接口的IP地址

- x：目的前缀

#### 热土豆路由选择

根据路由器到各个可达前缀的网关的开销路径，选择最低开销的路径，并将其添加到路由表

思想：尽快将分组送出AS，减少AS内部开销，自私的算法

#### 路由器选择算法

当有多条路由时，按顺序从下列规则选择

1. 本地偏好。由路由器设置或学习的，取决于网络管理员的策略
2. 最短AS-PATH。通过AS跳数衡量距离，通过DV算法决定路径
3. 热土豆路由选择
4. BGP标识符选择

### IP任播

1. 替换不同分散位置上不同服务器的相同内容：CDN
2. 让用户能从最靠近的服务器访问内容：DNS

具体使用BGP

不同的服务器使用相同的IP地址，通过BGP的方式来通告路由器，路由器进行路由选择，会选择最短的路径，因而每次向该IP地址请求时，均会向最近的服务器进行请求

### 路由选择策略

- 接入ISP不愿当内容提供商之间的路由
- 多宿接入时选择哪一个内容提供商/AS

## 网络管理和SNMP

### 网络管理

包括了硬件、软件、和人类元素的设置、综合和协调，以监视、测试、轮询、配置、分析、评价和控制网络资源，用合理的成本满足实时性、运营性能和服务质量的要求

入门知识：管理员在执行任务所使用的体系结构、协议和信息库

### 网络管理框架

- 管理服务器：控制网络管理信息的收集，处理，分析，显示
- 被管设备
- 管理信息库MIB：保存被管设备的关联信息
- 网络管理代理：悲观设备中与管理服务器通信的进程
- 网络管理协议

### 简单网络管理协议

Simple Network Management Protocol, SNMP是一个应用层协议，用于在管理服务器和代理之间传递管理和控制信息

采用请求响应模式

1. 管理服务器向代理发送请求，代理收到后进行操作（查询或修改），然后回答
2. 代理向管理服务器发送非请求报文（陷阱报文），用于通知管理服务器，MIB对象因异常而改变