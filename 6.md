# 6 链路层和局域网

## 差错检测和纠正技术

比特级差错检测和纠正：对比特损伤进行检测和纠正

使用差错检测和纠正比特EDC来增强数据D，对于收到的数据D\`检测有无差错

- 前向纠错：接收方检测和纠正差错的能力FEC

### 奇偶检验

使用单个奇偶检验位(parity bit)，在偶检验的方式下，所有位加上附加检验位1的个数为偶数

偶数个比特差错时无法检验

#### 二维奇偶检验

行与列均设置奇偶检验位，不仅可以检测比特差错，还可以纠正

### 检验和方法

数据作为一个d比特的整数序列处理，所有整数进位加起来，取反则为检验和

加法溢出则移到最低位

因特网检验和：d=16

接收方对接受的数据和检验和求和，检测结果是否为全1，不是则出错

### 循环冗余检测

Cyclic Redundancy Check, CRC编码，也称为多项式编码

可以检测连续的突发差错

#### 操作

1. 对于d比特的数据D，协商一个r+1位的比特模式，称为**生成多项式G**。
2. 发送数据D时，选择**r个附加比特R**，附加到D上，使该**d+r**比特模式模2算术（加法和减法没有进位借位）刚好**被G整除**
3. 检测过程：用G除接收到的比特，若有余数，则有差错
4. R的计算：$D*2^r\over G$的余数

## 多路访问链路和协议

- 点对点链路：由链路一端的单个发送方和链路另一端的单个接收方
- 广播链路：能够让多个发送和接收节点连接到相同的单一的共享的广播信道
- 多路访问问题：如何协调多个发送和接收节点对一个共享广播信道的访问
- 多路访问协议：规范在共享广播信道上的传输行为
- 多个节点可以传输帧，节点可能同时收到多个帧，导致传输的帧在所有的接收方处**碰撞**，没有一个节点可以获得有效的帧

### 多路访问协议

应具有特性

- 只有一个节点发送数据时，能有全部的吞吐量
- 多个节点发送数据时，能平等共享带宽
- 协议是分散的
- 协议是简单的

#### 信道划分协议

在共享信道之间划分广播信道带宽

##### 时分多路复用

- TDM，将时间划分为时间帧，每个时间帧划分为时隙slot

- 然后将时隙分配给不同的节点
- 每个节点只能在分配到的时隙内传输分组比特

缺陷

- 平均速率被限制，即使只有一个节点
- 总是在等待轮次

优点

- 具有公平性
- 消除碰撞

##### 频分多路复用

FDM，将信道划分为不同的频段，分配给节点

具有TDM的优点和缺点

##### 码分多址

Code Division Multiple Access, CDMA为每个节点分配一种编码方式，每个节点使用唯一的编码对发送的数据进行编码

不同的节点能够同时传输，接收方也能接受数据比特

#### 随机接入协议

节点以全部速率进行传输，碰撞时等待一个随机时延后重发帧，直到无碰撞

##### 时隙ALOHA

假设

- 将时间划分为时隙，每个时隙可传输1帧
- 节点只在时隙开始传输数据
- 节点是同步的，知道时隙开始
- 一个时隙内有碰撞，所有节点在时隙结束前均可检测到

步骤

1. 需要发送帧时，等待下一个时隙开始时发送
2. 发送时没有碰撞则成功传输
3. 若碰撞，在往后的每个时隙开始时以概率p重传直至成功传输

效率：长期运行成功时隙（刚好有一个节点传输）的份额，最大为0.37；推导过程

##### ALOHA

没有时隙的限制，帧到达节点后马上发送，如果碰撞，则马上以概率p重传，否则等待一个帧传输时间，再以概率p重传

其效率为带时隙的一半

##### 载波侦听多路访问

Carrier Sense Multiple Access, CSMA

- 载波侦听：在传输前先听信道，如果有帧在发送，则等待

为什么有载波侦听还会出现碰撞？

- 信道传播时延。比特沿着广播信道传输需要时间，在进行载波侦听时可能比特还未传输到达该节点处，无法侦听到
- 时延越长，不能侦听到的机会越大

##### CSMA/CD

CSMA/CD(Collision Detection), 带有碰撞检测的CSMA

- 碰撞检测：节点在传输时也监听信道，如果有人发送干扰帧，就停止传输，重新进入载波监听阶段

步骤

1. 适配器从网络层获取数据报，封装成帧，进入缓存
2. 侦听信道空闲（无信号能量进入适配器）时开始传输帧，否则等待直至空闲
3. 传输时，适配器监听有无其它适配器的信号能量。
4. 若有，发生碰撞。终止传输，等待一个随机时间回到2
5. 若无，完成传输

二进制指数后退算法：随机时间间隙的选择。碰撞越多，选择的范围越大。n次碰撞后，随机范围为0-$2^n-1$.n最大值为10

效率：$$1\over 1+5d_{prop}/d_{trans}$$

#### 轮流协议

- 轮询协议：指定一个主节点，以循环方式轮询每个节点。对于每个节点，告知其最大传输帧数量，待其传输后，轮询下一个
  - 优点：解决碰撞和空时隙
  - 缺点：轮询时延/主节点故障（健壮性）
- 令牌传递协议：令牌为小的特殊帧，在节点间按照固定的次序进行交换，收到令牌后才可传输帧，传输后或不传输则转发令牌
  - 单个节点故障则整个信道崩溃
  - 令牌忘了释放

#### DOCSIS：电缆因特网接入的链路层协议

综合应用多路访问协议

- CMTS：电缆调制解调器端接系统
- 上行下行信道都使用了FDM，划分多个频率信道
- 下行信道只有单一个发送点，无碰撞
- 每个上行信道划分时间间隔，时间间隔包含时隙序列，由CMTS通过下行信道分配，防碰撞
- CM一开始通过随机接入的方式传输，然后才被CMTS得知并分配时隙

## 交换局域网

### 链路层寻址和ARP

#### MAC地址

链路层地址，适配器/网络接口的地址，具有6个字节，以十六进制表示

MAC地址是固定的，且每个适配器的MAC地址不相同，由IEEE管理MAC地址空间，制造商获取一段空间进行制造分配MAC地址

广播地址：FF-FF-FF-FF-FF-FF

#### 地址解析协议

Address Resolution Protocol， ARP 将网络层地址和链路层地址进行转换

ARP只为同一个子网的主机和路由器进行解析

跨链路层与网络层的协议

##### 过程

1. 首先查ARP表，找有无相应项
2. 若无，则广播ARP查询分组封装的帧，ARP模块收到后若能在自己的ARP表中查询到，则返回标准帧封装的ARP响应分组，主机收到后更新ARP表

##### ARP表

字段

- IP地址
- MAC地址
- TTL

### 以太网

- 集线器：每个比特到达后复制向其它所有接口传输
- 交换机：无碰撞；存储转发交换机；全双工通信
- 转发器：输出端再生输入端信号，用于获得更长的运行距离
- 现代以太网通过交换机已经避免碰撞，甚至不需要MAC协议

#### 特点

- 无连接
- 不可靠：差错直接丢弃

#### 帧结构

- 数据字段：46~1500字节，超过则数据报分片，不足则填充
- 目的地址
- 源地址
- 类型字段：上层协议（包括ARP
- CRC：4字节
- 前同步码：前7个字节相同，第8个变化，用于唤醒接收的适配器并同步时钟

### 链路层交换机

交换机对子网中主机和路由器是透明的

带缓存

#### 转发和过滤

- 过滤：决定一个帧应该转发还是丢弃
- 转发：决定一个帧应该导向哪个接口

##### 交换机表

表项

- MAC地址
- 通向MAC地址的接口
- 放在表中的时间

操作

- 无相应的MAC地址表项则广播到其它所有接口
- 有表项且接口与到达接口一致则过滤
- 根据交换机表导向对应接口

#### 自学习

自学习建立交换机表

即插即用

1. 初始为空
2. 收到一个入帧时，往交换机表插入一项
3. 一段时间（老化期）后，没有收到该源地址的帧，则删除记录

#### 性质

- 消除碰撞
- 异质链路
- 管理：强化安全性

#### 与路由器对比

- 转发根据的地址不同
- 层次不同
- 交换机
  - 即插即用
  - 相对高的过滤和转发速率
  - 大型网络ARP表生成巨大流量和处理量
  - 广播风暴没有保护
- 路由器
  - 分层次寻址
  - 广播风暴提供防火墙保护

### 虚拟局域网VLAN

交换机局域网问题

- 缺乏流量管理：广播无法限制
- 交换机无效使用
- 管理用户：用户在组间移动

可通过虚拟局域网解决

单个物理局域网可以定义多个虚拟局域网，同一VLAN主机彼此通信

#### 基于端口

基于端口的VLAN，由管理员将端口划分为组，每个组为一个VLAN，这些端口形成一个广播域

交换机维护一种端口到VLAN的映射表

除此还可基于MAC地址

#### 隔离VLAN的交流

- 同一个交换机：单臂路由：通过一个端口连接到路由器，该端口同时属于两个VLAN

- 两个交换机：VLAN干线连接，干线端口属于所有VLAN
- 扩展的以太网帧格式：802.1Q增加VLAN标签