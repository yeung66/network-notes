# 4 网络层：数据平面

## 网际协议

Internet Protocol

### IPv4

#### 报文

分组称为数据报，关键字段

- 版本号：4比特
- 首部长度：4比特
- 服务类型：8比特，区别不同类型的IP数据报，如实时数据报/非实时流量
- 数据报长度：16比特，首部+数据
- 标识，标志，片偏移：与IP分片相关
- 寿命TTL：确保不会永远循环，每个路由器处理一次减一，减为0时丢弃
- 上层协议
- 首部检验和：16位检验和，每台路由器处理后均要重新计算
- 源和目的IP地址
- 选项：可选扩展首部
- 数据：上层运输层的报文/ICMP报文

首部无选项时为20字节

#### 分片

数据报比链路层帧所能承载的数据量要大时，需要把数据报分成几个较少的数据报，这些数据报称为片fragment

- MTU：链路层帧最大传输单元
- 当路由器发现数据报长度要比出链路的MTU大时，进行分片，每个分片采用单独的链路层帧
- 目的主机进行分片的组装
  - 数据报的分片具有相同源目的地址，标识号
  - 标志比特确定是否最后一个片
  - 片偏移用于决定顺序并重新组装

#### 编址

- 接口：主机与物理链路之间的边界，每个接口与一个IP地址关联
- 一个地址32位，采用点分十进制记法
- 子网掩码：前多少比特定义子网
- 子网：隔离的网络岛

##### 地址分配

- 无类别域间路由选择（Classless Interdomain Routing, CIDR)
  - 地址分为两部分，前x位为网络部分，通常成为前缀
  - 后32-x位用于标识网络组织内部设备

- 分类编址：网络部分长度固定为8，16，24，分别为A，B，C类网络
- 广播地址：255.255.255.255，报文会交付给所有主机
- 具体流程：
  1. 从ISP获取一块地址，ISP从ICANN组织获取地址
  2. 获取地址后，为组织内部的主机和路由器接口分配IP地址
     - DHCP
     - 手动配置

- 动态主机配置协议DHCP：允许主机自动获取（被分配）一个IP地址，以及子网掩码，第一跳路由地址（默认网关），本地DNS地址
  - 即插即用，零配置协议
  - 由子网的DHCP服务器提供/或DHCP中继代理提供DHCP服务器地址
  - 步骤
    1. DHCP服务器发现。主机通过UDP向67端口广播DHCP发现报文
    2. DHCP服务器提供。服务器用DHCP提供报文进行响应，报文全子网广播。提供报文包括发现报文事务ID，推荐IP地址，网络掩码，IP地址租用期（有效的时间量）
    3. DHCP请求。客户选择一个服务器并用DHCP请求报文响应
    4. DHCP ACK。服务器进行响应。

### 网络地址转换NAT

- 专有网络：地址仅对该网络中其它设备有意义的网络
- 通过NAT，所有流出路由器的报文都有相同的源地址，进入路由器的报文都有相同的目的地址。这两者地址为路由器的地址
- NAT转换表：决定分组应该转发给那个内部主机，地址+端口
- 当内部主机发送报文时，路由器分配端口，改写数据报的源地址与端口号，往NAT表中插入记录
- 路由器接收到报文后，根据NAT转换表改写数据报的地址与端口，进行转发

### IPv6

#### 数据报

##### 变化

- 地址容量扩大：128比特；引入任播地址：交付给主机中任意一个
- 简化高效首部：40字节
- 流标签

##### 结构

- 版本
- 流量类型
- 流标签：20比特；标识流，给出优先权
- 有效载荷长度：首部后数据长度
- 下一个首部：标识上一层协议
- 跳限制：等同于IPv4的寿命，每个路由器转发一次减1，为0时丢弃
- 源地址和目的地址
- 数据

##### 特点

- 没有分片：当数据报过大时，向发送主机返回分组太大的ICMP差错报文，由端系统进行分片
- 没有首部检验和：为了快速处理（因为有寿命/跳限制，每次转发都要修改，所以需要重新计算
- 没有选项，可能出现在下一个首部指示的位置

#### 迁移

向后兼容：支持IPv6的系统也支持IPv4

通过隧道方法使IPv4兼容IPv6

- 隧道：IPv6节点之间IPv4路由器集合
- 隧道发送端的IPv6节点将IPv6数据报整个放在IPv4数据报中
- 隧道接收端IPv6节点从IPv4数据报中取出，继续传输（通过首部的协议号字段判断